<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pirate Birthday Invite</title>
  <style>
    body {
      font-family: "Treasure Map Deadhand", cursive, sans-serif;
      background: #fdf6e3;
      color: #3b2f2f;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      flex-direction: row;
      padding: 20px;
    }
    .invite, .guestlist {
      flex: 1;
      padding: 20px;
    }
    .popup {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:1000;
    }
    .popup img {
      max-width:80%;
      border:5px solid #fff;
      border-radius:10px;
    }
    #closePopup {
      margin-top:20px;
      padding:10px 20px;
      background:#d4af37;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:18px;
      font-weight:bold;
    }
    form input, form textarea {
      display:block;
      margin:10px 0;
      padding:8px;
      width:100%;
      max-width:300px;
    }
    .confirmation {
      margin-top:10px;
      padding:10px;
      background:#e0ffd4;
      border:1px solid #7c9c6b;
      display:none;
    }
    .meta {
      font-size:0.9em;
      color:#555;
    }
  </style>
</head>
<body>

<!-- Image popup on load -->
<div class="popup" id="imagePopup">
  <img src="pirate-me.jpg" alt="Birthday Surprise" />
  <button id="closePopup">Enter digital vessel</button>
</div>

<div class="container">
  <div class="invite">
    <h1>Ahoy Matey! üéâ</h1>
    <p>Come celebrate me voyage 'round the sun!</p>
    <form id="rsvpForm">
      <input type="text" id="name" placeholder="Yer Name" required>
      <input type="email" id="email" placeholder="Yer Email" required>
      <label><input type="radio" name="attend" value="Aboard" required> Aboard</label>
      <label><input type="radio" name="attend" value="Marooned"> Marooned</label>
      <textarea id="message" placeholder="Leave a note for the crew"></textarea>
      <button type="submit">Send Yer RSVP</button>
    </form>
    <div id="confirmation" class="confirmation"></div>
    <button id="printBtn">üñ®Ô∏è Print Invite</button>
  </div>
  <div class="guestlist">
    <h2>Crew Manifest ‚öì</h2>
    <div id="rsvpList"></div>
  </div>
</div>

<audio id="partyMusic" src="pirate-music.mp3" preload="auto"></audio>

<script>
// CHANGE THIS to your deployed Google Apps Script web app URL
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxIXUB1RnmKEUv9sJqMmtVkBTHyUBpmFtmsn-_SLzMm7FQNTu8Setd1NOjtJYtx2nGpyw/exec";

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('rsvpForm');
  const rsvpList = document.getElementById('rsvpList');
  const confirmation = document.getElementById('confirmation');
  const printBtn = document.getElementById('printBtn');
  const closePopup = document.getElementById('closePopup');
  const imagePopup = document.getElementById('imagePopup');
  const partyMusic = document.getElementById('partyMusic');

  // ‚úÖ Popup close button
  closePopup.addEventListener('click', () => {
    imagePopup.style.display = 'none';
    partyMusic.play();
  });

  // ‚úÖ Submit RSVP
  form.addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('name').value.trim() || 'Anonymous';
    const email = document.getElementById('email').value.trim();
    const attend = document.querySelector('input[name="attend"]:checked').value;
    const message = document.getElementById('message').value.trim();

    // Send as form-encoded data instead of JSON
    fetch(SCRIPT_URL, {
      method: 'POST',
      body: new URLSearchParams({ name, email, attend, message })
    })
    .then(res => res.json())
    .then(() => {
      confirmation.style.display = 'block';
      confirmation.textContent = `Many a thanks pirate ${name}! Yer RSVP has been logged.`;
      form.reset();
      loadResponses();
      setTimeout(() => confirmation.style.display = 'none', 5000);
    })
    .catch(err => alert("Error sending RSVP: " + err));
  });

  // ‚úÖ Load RSVPs
  function loadResponses() {
    fetch(SCRIPT_URL + "?action=get")
      .then(res => res.json())
      .then(data => {
        if(!data || !data.length){
          rsvpList.innerHTML = '<p class="meta">Place yer name here fellow swashbuckler!</p>';
          return;
        }
        rsvpList.innerHTML = data.map(entry => `
          <div style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.03)">
            <strong>${escapeHtml(entry.name)}</strong> ‚Ä¢ <span class="meta">${escapeHtml(entry.attend)}</span>
            ${entry.message ? `<div style="margin-top:6px">${escapeHtml(entry.message)}</div>` : ""}
          </div>
        `).join('');
      });
  }

  function escapeHtml(s){
    if(!s) return '';
    return String(s).replace(/[&<>"']/g, ch => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[ch]));
  }

  // ‚úÖ Print button
  printBtn.addEventListener('click', () => window.print());

  // ‚úÖ Initial load
  loadResponses();
});
</script>

</body>
</html>
